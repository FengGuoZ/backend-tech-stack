## 计算机网络  - 自顶向下方法

### 第1章 概论

#### 1.1 什么是Internet

**Internet -- 因特网**

- **由TCP/IP协议族支撑起的1种计算机网络**，通过网络连接设备将一堆网络连接在一起
- 前身为美国军方资助的**分组交换网络ARPANET**
- Internet是众多计算机网络中的1种，此外还有银行专用网络、军用网络等



**网络**

- 由**节点和边构成**的，与大小无关的拓扑
- 抽象的概念



**节点**

- **主机节点** -- 手机、web服务器等端设备，产生和接收数据
- **数据交换节点** -- 中继器、交换机、路由器、负载均衡设备，转发数据



**边** -- 在计算机网络中即通信链路

- **接入链路** -- 主机节点接入到计算机网络的链路
- **主干链路** -- 路由器之间的链路



**协议**

- 协议是**分布式的对等层实体在信息交换过程中遵守的规范集合**

- 规范包括语法、语义、时序



#### 1.2 网络边缘

**网络结构** -- 网络中存在3级结构

- edge(边缘) core(核心) access(接入)
- **edge通过access接入core**  

- 原系统和目标系统之间就像有一个**瞬间切换开关** -- core提供的服务 -- **switch**

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220616105935351.png" alt="image-20220616105935351" style="zoom:50%;" />



**网络边缘** 

即端设备



**客户端/服务器模式**

主从结构 -- 服务器主、客户端从

**peer2peer模式**

端对端模式 -- 迅雷



#### 1.3 网络核心

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220617011134416.png" alt="image-20220617011134416" style="zoom: 67%;" />



**网络核心**

- 指由**分组交换机和链路构成的网状网络**

- 分组交换机器包括

  - 路由器

  - 链路层交换机



**线路交换**方式

- **独享线路**，多用于电话网络

- 线路交换节点之间的带宽的分片方式

  - 频分 -- FDM

  - 时分 -- TDM

  - 波分 -- WDM



**分组(packet)交换**方式

- 存储转发，**共享线路**
- 分组交换下网络核心的**关键功能**
  - **路由** -- 决定packet采用的源到目标的路径，由**路由算法**计算得出
    - 控制平面功能
  - **转发** -- 将packet从路由器的输入链路转移到输出链路
    - 数据平面功能



#### 1.4 接入网络和物理媒体

**接入网络将端设备接入网络核心**



**modem** -- 调制解调器

- 一种家用网络设备，俗称猫，作为为modulate和demodulation

- cable modem -- 用于复用电话线、有限电视线（**同轴电缆**）提供网络带宽



**链路物理媒体**

- 同轴电缆 -- 有线电话线、有限电视线
- 双绞线 -- 网口线
- 光纤 -- 网络干线采用
- 地面微波 -- 电信塔
- 卫星微波



#### 1.5 Internet结构和ISP

**ISP**(Internet Service Providers 网络服务提供商)

- **端系统通过ISP接入到Internet**
- 移动ISP、联通ISP、高校ISP



**IPS具有层次结构** -- Global ISP、Region ISP、Local ISP

- **一级ISP**完成**国际覆盖，两两互连，带宽极高**，如UUNet，BBN
- 二级ISP 三级ISP...
- 最终通过**local ISP**将端设备接入Internet



#### 1.6 分组延时、丢失和吞吐量

**4种分组延时** -- 任意2节点之间的分组传递消耗的时间

- **排队延时** -- 吞吐量不足时发生排队等待，取决于拥塞程度
- **传输延时** -- L/R(packet长度/链路带宽)，ms级别
- 处理延时 -- 校验、计算等处理，μs级别
- 传播延迟 -- 卫星距离长，μs-几百ms级别



**tracert** 查看两端之间的**中间节点**以及**往返延时**

- 基于**ICMP报文实现**（网络层协议），每次发送3个报文，测量往返延时
- TTL从1递增，直至找到目标主机

```bash
$ tracert baidu.com	# 查看本机和baidu服务器之间的延时
```

![image-20220617230107661](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220617230107661.png)



#### 1.7 协议层次及服务模型

**服务service**

低层实体向上层实体提供的功能



**服务访问点SAP**

服务提供者提供服务的位置，**传输层的SAP为port**



**协议与服务的关系**⭐

- 本层协议基于下层服务实现
- 实现本层协议的目的是为上层提供更好的服务



**PDU** -- Protocol Data Unit **协议数据单元**

- 应用层 -- message，报文
- 传输层 -- **segment**，报文段
- 网络层 -- **packet**/datagram，分组/数据包
- 数据链路层 -- frame，帧（有头有尾）
- 物理层 -- bit，位



**Internet协议栈**

- 应用层 -- 网络应用，HTTP、FTP、DNS
- 传输层 -- 端进程之间的数据传输，TCP、UDP
- 网络层 -- **端到端**之间路由，IP、ICMP
- 链路层 -- **相邻网络节点之间**的数据传输，PPP、802.11WLAN、802.3Ethernet、ARP
- 物理层 -- 数模信号转化，在物理线路上传送bit



计算机网络中**一次数据传输过程**

- 主机节点为7层设备

- 数据交换节点只要2-3层，最高层为网络层
  - router3层
  - switch2层

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220618093710757.png" alt="image-20220618093710757" style="zoom: 80%;" />



### 第2章 应用层

#### 2.1 应用层协议原理

**应用类型**

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220618101807204.png" alt="image-20220618101807204" style="zoom: 67%;" />



**用户代理(正向代理)** -- 各种客户端软件

- HTTP用户代理 -- Edge浏览器
- FTP用户代理 -- FTP软件
- SMTP用户代理 -- Foxmail



**常见知名端口**

- 21 -- FTP
- 22 -- SSH

- 23 -- Telnet

- 53 -- DNS

- 80 -- Http



**Endpoint**

端节点，层间提供服务的位置



**Socket(套接字)**

- 应用层每次信息传输时，都需要指定IP+Port+Data给传输层

- 可用socket**对固定的信息进行标识**，不用每次重复传输，**减少层间信息量**

  - **TCP socket四元组** -- [本机IP:本机Port; 目标IP:目标端口]的本地标识
  - **UDP socket二元组** -- [本机IP:本机Port]的本地标识，**[目标IP:目标端口]可变**



**TCP和UDP均为明文传输**，提供的服务**不具备安全性**，安全性由应用层实现



#### 2.2 web & HTTP

**HTTP** -- 超文本传输协议

- 超文本即非线性文本，**文件之间有指向关系**
- 超文本包括图片、音频、视频



**cookie** 

- **给http打上状态补丁**

  - http1.0默认无状态

  - http1.1可选

![image-20220619172405421](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220619172405421.png)



**web缓存** -- **正向代理服务器**

- 浏览器访问Proxy server
- 由Proxy server 访问源服务器，并**缓存response**

![image-20220619172034147](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220619172034147.png)

proxy是特殊的主机节点，LAN中的其余主机节点**通过它间接访问Web服务器**

![image-20220619195952442](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220619195952442.png)

window下设置proxy

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220619173002706.png" alt="image-20220619173002706" style="zoom: 67%;" />



**proxy缓存一致性**

Http咋Request中加入**`If-modified-since`**字段，获取缓存有效性信息，**打上缓存过期bug补丁**



#### 2.3 FTP

FTP服务器监听21号端口，等待客户端连接



常用命令

```bash
USER username
PASS password
LIST
RETR filename
STOR filename
```



#### 2.4 Email & SMTP

**SMTP** -- 发送邮件协议

- SMTP要求只能发送Ascii码范围内的数据[0, 127)
- 打上**Base64编解码补丁**后可以传输任意类型数据
  - Base64原理 -- `3 x 8 = 4 x 6`
  - 将3字节可能超过127的明文，转化为4字节[0, 64)范围内的base64编码



POP3 -- 邮件拉取协议



#### 2.5 DNS

**域名服务器DNS**

- 位于**应用层**的基础设施，本质上属于端系统
- 为应用层应用**提供域名解析、域名重定向**等服务服务



**DNS实现**

- **分层树结构**，基于域的命名机制，避免冲突+提高可读性
  - 数百个顶级域名 -- `.com .org .edu .us .cn`
  - 下挂二、三级域名
  - **叶节点为主机节点域名**

- 分布式数据库完成IP地址转化
- **运行在UDP**之上的port=53的应用（**强事务性**）
- 身是网络核心功能，但以应用层协议实现（**在网络边缘处理复杂性**）



**根服务器与TLD 服务器**

- 根服务器相当于/，全球共13个，无缓存的域名查询，都要从根服务器开始，**向下递归查询**

- TLD -- Top-Level Domain，顶级域名服务器



**设备上网必备信息**，可手动配置或通过DHCP协议从DHCP服务器获取

- 本机IP
- 子网掩码
- DNS IP
- GateWay Ip

![image-20220619222556018](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220619222556018.png)



**DNS协议报文格式**

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220619223247907.png" alt="image-20220619223247907" style="zoom: 80%;" />





#### 2.7 CDN

**视频流量目前占据大部分互联网带宽**，总量80%以上，故称流媒体时代



**DASH** -- Dynamic Adaptive Streaming over HTTP **多媒体流化服务**

- **服务器将视频切割成8~10S的片段，以不同码率编码**，形成manifest file告示文件

- 客户端通过HTTP请求视频流片段，并**根据网络状态切换码率**，拉取manifest file对应资源



**集中式超级流媒体服务器存在的问题**

- 分布式客户端与中心服务器之间的跳数较多

- 重复流量多，浪费带宽

由此引出CDN



**CDN** -- Content Delivery Network **内容分发网络**，提供**流媒体加速服务**

- CDN有专门的运营商，分布式部署大量缓存节点，**缓存DASH片段**
- 终端用户向源服务器请求数据后，通过**域名解析重定向到最近的CDN**，以获取优质服务
- 本质是**让内容更靠近用户**



**ICP** -- Internet Content Provider **互联网内容供应商**（如ByteDance）

- 需要租用CDN运营商的CND服务器，并提前部署热门流媒体资源
- CDN的节点部署策略和ICP的内容缓存策略至关重要



### 第3章 传输层

#### 3.1 传输层服务

IP向传输层交付Best Effort服务，不保证可靠性

**TCP加强了IP的服务**，向上层**交付可靠的信息传递**（不重不漏）

**UDP依旧向上层交付尽力而为的服务**，只是用端口区分了进程



#### 3.2 多路复用和解复用

**多路复用** -- **IP层提供的服务**，发生在**从传输层到IP层**的过程中

- 不同传输层实体复用同一个IP层服务

- 源主机传输层从不同套接字中收集数据块，封装上传输层头部，交付给网络层



**多路分解** -- **传输层提供的服务**，发生在IP层到传输层的过程中

- 将主机到主机的数据，**区分为进程到进程的数据**

- 目标主机传输层将收到的报文的数据，将传输层头部解封装，**交付到正确的套接字**



**复用解复用过程中**

- TCP通过4元组**定位**socket，通过socket**获取**4元组

- UDP通过2元组定位socket，通过socke获取2元组



#### 3.3 无连接传输 UDP

**UDP适用对象**

- 流媒体应用 -- 实时性要求高，数据量大

- 事务型应用 -- DNS服务



**UDP报文格式**

- **`8B固定长度头部 = 2B源端口 + 2B目标端口 + 2B长度(含头部) + 2B校验和(EDC)`**

- EDC -- **差错控制编码**，检测范围包括头部 + 报文

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220620155230491.png" alt="image-20220620155230491" style="zoom: 80%;" />



#### 3.4 RDT原理

**RDT** -- Reliable Data Transport **可靠数据传输**

- 通常**由传输层TCP实现**

- 理论上也可以交由应用层自己实现

- 下层服务的不可靠性，决定了RDT实现的复杂性



##### RDT1.0 可靠信道上的可靠数据传输

本层只需封装+转发



##### RDT2.0 具有比特差错的信道

- 引入**checksum校验**

- **接收方需回复ACK确认**，发送方**停止等待ACK**（ACK本身也要EDC）

- **发送方需缓存数据，以备重传**

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220620181414554.png" alt="image-20220620181414554" style="zoom: 67%;" />



##### RDT2.1 修复ACK出错的bug

RDT2.0 不完备 -- 当ACK出错时，发送方无法处理（如果重发可能导致重复，如果不重发可能丢失数据）

- **引入序号**，发送方给数据编上序号P0、P1、P2...Pi...

- 当发送方收到错误ACK后，立即重传

- 接收方根据序号去重

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220620194257566.png" alt="image-20220620194257566" style="zoom:67%;" />



##### RDT3.0 具有比特差和分组丢失的信道

信道可能丢失packet，包括Pi和ACK

- **引入超时重传机制**，发送方在定时器超时而ACK未到时，重传packet
- 超时时间合理值 = 均值 + kσ
- RDT3.0是相对完美的协议，但1次只发1个分组，存在效率问题



##### 滑动窗口协议 sliding window⭐

**发送缓冲区** 

- 内存中的一块区域，用于存放已发送但未确认的packet

- 只有落在发送缓冲区之内分组允许被发送



**发送窗口**

- **发送缓冲区子集**，**存放当前已发送未经确认的packet**，

  - 发送新分组 -- 窗口前沿向前滑动

  - 收到ACK -- 窗口后沿向前滑动

  - 前沿 - 后沿 ≤ 发送缓冲区大小

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220620215607067.png" alt="image-20220620215607067" style="zoom:50%;" />



**接收窗口**

- 接收窗口控制哪些分组可以被接收

- 接收窗口尺寸Wr>1时，允许乱序接收

- **滑动方式**

  - 低序号分组到来，接收窗口移动

  - 高序号分组乱序到来，**缓存但不交付**（保证向上层有序交付），不滑动

- **发送确认**

  - Wr = 1 -- **累计确认**，对顺序到来的最高位分组进行确认，收到ack4意味着分组0-3必定已收到

  - Wr > 1 -- 非累积确认，收到ack4不意味着分组0-3必定已收到



**GBN协议与SR协议**

- 滑动窗口协议的特化对象
  - Sr>1 Wr=1 -- GBN协议
  - Sr>1 Wr>1 -- SR协议

![image-20220620225751948](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220620225751948.png)



##### RDT3.1 将停止等待协议升级为pipeline协议

基于滑动窗口协议实现



#### 3.5 面向连接的传输 TCP

**TCP报文格式** -- 首部长度可变，**通常为固定20B**

- **`20B头部 = 源端口2B + 目的端口号2B + 序号4B + 确认号4B + 标志位 + 确认窗口2B + 校验和2B + ...`**

- 序号和确认号均以字节为单位，本质是**对TCP字节流的编码**

  - ack = 10，标识已经收到0-9数据，希望对方发送10及以后的数据（**具有累计确认含义**）

  - seq = 18，表示当前报文**数据部分的首字节**在字节流中的offset=18

- **ACK标志位置1使能ack字段**，否则ack无效

- 与UDP不同，**TCP报文没有专门字段指明数据部分长度**
  - **`TCP Data的长度= IP总长度 - IP Header长度 - TCP Header长度`**
  - UDP  Len字段是冗余信息

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220620231459263.png" alt="image-20220620231459263" style="zoom: 40%;" />



**TCP如何保证RDT**⭐

- **校验和**

  - 检验传输过程是否出错

  - 承载于报文校验和字段2B，用EDC检验

- **累积确认**

  - 接收方确认已收到的字节流编号

  - 承载于报文ack字段4B

- **超时重传**

  - 用于重发丢失的报文段

  - 定时器超时未收到累积确认，触发重传

- **流量控制** -- **考虑对方感受**

  - **同步通信双方速率**，避免接收端应用层不取数据，而发送端持续发送数据

  - 采用捎带技术，**将接收方接收缓存区可用空间大小，发送给发送方**

  - 承载于报文接收窗口字段2B

- **拥塞控制** -- **考虑网络感受**
  - 根据网络拥堵状态，调整通信速率

- **连接管理**
  - 3握4挥



**TCP快重传**

在定时器到时之前，**发送方收到冗余的3个ACK，立即重传该ACK对应报文**

- 场景模拟 -- 发送方发送 10~14 15~19 20~24 25~29 四个报文段

- 15~19 20~24 25~29报文段先到达，接收方接收窗口乱序接收

- 由于累积确认机制，发送方会三次发送ack=10的确认报文

![image-20220621001809154](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220621001809154.png)





**捎带技术piggybacking**

AB双向通信，B在发送给A数据的过程中，**捎带**ACK信息及可用接收窗口信息



**TCP3次握手**⭐

**握手的目的**

- 同意建立连接 -- AB相互知道对方愿意建立连接

- 分配通信资源 -- 分配接收、发送缓冲区等资源

- **同步通信参数** -- 互相告知对方自己的初始Seq



**2次握手的缺陷**（为什么要3次握手）

- 握手请求超时重发，导致**服务器维护半连接**，浪费资源

- **把旧数据当成新数据接收**



**握手过程**

- 客户端经历3种状态 -- CLOSED → SYN-SENT → ESTABLISHED

- 服务端经历4种状态 -- CLOSED → LISTEN → SYN-RCVD → ESTABLISHED

- 第一次握手的SYN报文和第二次握手的SYN+ACK报文不含数据，但**消耗1个字节流序号**

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/format,png.png" alt="三次握手" style="zoom: 75%;" />



**TCP4次挥手**⭐

**挥手目的**

- 关闭双向连接

- 放连接资源



**挥手过程**

- 主动方经历5种状态，初始状态为ESTABLISHED

  - 发送FIN后进入FIN-WAIT-1状态

  - 收到ACK后进入FIN-WAIT-2状态

  - 收到FIN并发送ACK后进入TIME-WAIT状态

  - 2MSL后，进入CLOSED状态

- 被动方经历4种状态，初始状态为ESTABLISHED

  - 收到FIN并发送ACK后进入CLOSE-WAIT状态

  - 发送FIN后进入LAST-ACK状态

  - 收到ACK后进入CLOSED状态

- 被动方可能因未收到第四次挥手的ACK而重传FIN，所以主动方要经历2MSL的TIME-WAIT状态
  - **MSL**  Max Segment Lifetime-- 最大报文生存时间，TCP segment在网络core中的寿命

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/format,png-16558677703653.png" alt="四次挥手" style="zoom:75%;" />



#### 3.6 拥塞控制原理

网络通畅时，packet注入速度等于packet泵出速度

**网络拥塞(Congestion)**时，packet注入速度逐渐小于packet泵出速度，若不加控制，**会加速恶化直至死锁**



#### 3.7 TCP拥塞控制

TCP采用**端到端拥塞控制**，端系统感知拥塞并调整传输速度，**将网络的复杂性放在网络边缘处理**



**拥塞检测**

- 明显拥塞 -- 发生segment超时重传

- 轻微拥塞 -- 收到3次冗余确认



**控制策略** -- 通过调整CongWin(拥塞窗口) & Threshold(警戒值)实现

- **慢启动阶段** -- 连接建立时，CongWin以RTT(Round-Trip Time 往返延时)为单位，**指数级扩大**，直至达到Threshold

  - 初始拥塞窗口CongWin = 1MSS = 1460B

  - 慢启动阶段在整个传输过程中的时间占比极小

- **拥塞避免阶段** --  CongWin以RTT为单位，**线性增加**，直到检测到拥塞

- **快恢复动作** -- 收到3次冗余ACK，触发快重传，同时**CongWin减半**

- **超时重传时**，网络明显拥塞，重置CongWin=1MSS，回到慢启动阶段

![image-20220321161052219](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220321161052219.png)



**TCP的公平性** -- 瓶颈链路上的主机对，均分链路带宽



### 第4章 网络层 - 数据平面

#### 4.1 导论

**网络层的功能**

- **转发** -- 将packet从路由器输端口转发到输出端口

  - 本地功能(局部功能)

  - 数据平面功能

- **路由** -- 选择源主机到目标主机间的路径，全局功能

  - 全局功能

  - 控制平面功能



#### 4.2 路由器组成

**路由器** -- 实现数据平面和控制平面功能

- 控制平面计算路由表

- 数据平面匹配路由表，经过交换结构，将packet从输入缓冲区传送到输出缓冲区

- **路由器包含多个端口** -- 路由器有 ≥ 2个IP地址，**才能在不同的网络之间转发packet**

![image-20220622170022323](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220622170022323.png)



**端口缓冲区**

- 用于匹配局部瞬时速度差

- 缓冲区满后，**新到的packet可能会被丢弃**，所以IP层不可靠



#### 4.3 IP Internet Protocol

**IP报文格式** -- **20字节固定头部**

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220627102005862.png" alt="image-20220627102005862" style="zoom:80%;" />



**IP分片和重组**

**Fragmentation**

- Ethernet链路层MTU=1500，IP层需要**对超过MTU的packet进行分片**

- 分片会复制20B头部信息

 **Reassembly**

- **由目标主机完成**

- 根据IP报文中16bitID+flags+offset重组分片

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220627110850656.png" alt="image-20220627110850656" style="zoom:80%;" />



**子网 subnet**

**IP地址 = 网络号(高位bits) + 主机号(低位bits)**

- **网络号相同的节点**(主机/路由器)构成的网络的一部分叫做**子网**

- 子网内的各主机间**物理直达**，无需路由介入

- 互联网**以子网为单位计算路由** -- 包括路由信息的发布和路由信息的计算

  - 子网内的所有主机**聚集为路由中的1个表项**

  - 这种聚集可嵌套，以进一步收敛

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220627150238989.png" alt="image-20220627150238989" style="zoom: 80%;" />



**IPv4地址分类** -- ABCDE类

- A类 -- 以0开头，1B网络号 + 3B主机号

- B类 -- 以10开头，2B网络号 + 2B主机号

- C类 -- 以110开头，3B网络号 + 1B主机号

  - 日常使用的是C类IP地址

  - 范围从192.0.0.0到223.255.255.255



**mask子网掩码**

用于CIDR(无类域间路由)中**区分网络号/主机号**



**IP地址获取**

- 手动配置

- **DHCP动态获取** -- Dynamic Host Configuration Protocol

  - 运行DHCP客户端向DHCP服务器获取IP

  - DHCP承载于UDP上

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220627162736834.png" alt="image-20220627162736834" style="zoom:80%;" />



**路由表**

- **控制平面和数据平面通过路由表联系**

- **`目标IP & Mask = 路由表项202.38.73.0`**时，将packet转发至IPx

- IPx即通过路由匹配的得到的next hop地址




<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220627154304077.png" alt="image-20220627154304077" style="zoom:80%;" />



**路由聚集**

- 聚集指将路由表中满足条件的同类子网，聚集为1个表项

  - 减少广域网中的路由表条目数

  - 减少**路由信息通告**的数量

  - 减少路由计算代价



**NAT 网络地址转换**

Network Address Translation -- **用于解决IPv4地址不足的问题**，**正向代理子网内部请求**

- 本地网络（内网）只有一个有效IP地址，由**NAT路由器持有**

- 内网包含的多台主机设备，对外共用一个外网IP

- 内网主机对内使用内网IP，如10.0.0.1，内网IP对外不可见

- NAT路由器**负责内外网IP地址转化**

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220627214348112.png" alt="image-20220627214348112" style="zoom:80%;" />



#### 4.4 通用转发和SDN

**传统互联网网络设备特点** -- **垂直继承**

- 硬件、操作系统、软件捆绑

- 导致行为僵化，难以升级



**SDN 软件定义网络**

Software Defined Network -- **逻辑上的集中控制平面**

- 将**数据平面和控制平面分离**（传统方法是在路由器上统一实现）

- 数据平面 -- 分组交换机，**按照流表动作**，可表现为多种网络设备
  - 分组交换机为分布式

- 控制平面 -- 控制器 + 网络应用，计算和下发流表给分组交换机
  - 远程、集中的控制中心



### 第5章 网络层 - 控制平面

#### 5.2 路由选择算法

**路由选择**

- 在网络拓扑中，通过路由算法找到**最优路径**，**生成路由表**

- 路由信息**以子网为单位**计算



**路由算法**

- 输入 -- 网络拓扑、边的代价、源主机地址

- 输出 -- 源主机到所有主机的最优路径，即**汇集树**



**全局路由算法** -- 路由器拥有**完整**网络信息

- LS算法 -- Link Stat 链路状态算法，核心是Dijkstra算法

- LS路由过程

  - 每个路由器将自己与相邻节点的代价封装为LS分组

  - 将该**LS分组泛洪**至全网

  - 使用**Dijkstra算法**计算最优路径，**生成路由表**

![image-20220630113253048](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220630113253048.png)



**局部路由算法** -- 路由器知道物理**相邻**路由器代价

- distance vector routing -- 距离矢量路由选择



#### 5.3 单一自治系统路由选择

**AS** -- Autonomous System单一自治系统，**可由多个子网组成**

- 将互联网分成1个个AS区域

- AS区域以唯一ASN标识



**内部网关协议** -- 基于LS实现的AS内部协议

- RIP -- 路由信息协议

- OSPF -- 开放式最短路径优先



#### 5.4 ISP之间的路由选择 - BGP

**BGP 边界网关协议**

 Border Gateway Protocol -- 用于AS之间的路由选择

- 分层路由体系

  - AS内部

  - AS之间



**网关与路由器**

网关即出口路由器，位于ISP接入/不同网络连接处

![image-20220630163357361](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220630163357361.png)



#### 5.5 SDN控制平面

由SDN控制器上的网络OS集中实现



### 第6章 链路层和局域网

#### 6.1 链路层服务

**LAN与WAN**

- 局域网为多点连接

- 广域网为点到点连接，如跨太平洋海底光缆
  - 由2条单工实现双工，以避免碰撞

- 局域网链路层复杂度远高于广域网



**链路层服务**

- 将数据包封装在frame中，加上帧头帧尾
  - frame头部为源MAC地址和目标MAC地址

- 在相邻node间完成RDT



**网卡(Adapter NIC)实现了链路层和物理层功能**，两层紧密捆绑

- IP层路由器负责子网到子网


- **子网内部节点之间的传输由链路层负责**



#### 6.2 差错检测和纠正

**物理层**

**IEEE 802.3以太网协议** -- 同轴电缆、双绞线、光纤出错率低，不需要差错控制

**IEEE 802.11WLAN无线网协议** --  出错率高，需要额外实现RDT



#### 6.3 多点访问协议

多点接入问题 -- 各个节点协调使用共享性介质



**接入访问控制方式**

- 信道划分 -- TDMA FDMA CDMA 时分 频分 码分

- 随机访问 -- 随机获取使用权

  - ALOHA

  - CSMA/CD -- IEEE802.3 Ethernet中使用

  - CSMA/AD -- IEEE802.11 WLAN中使用

  - 二进制指数退避

- 令牌环网 -- 发送方需抓住token才能发送消息，由IBM开发



#### 6.4 LANS

**ARP协议** -- 完成IP地址到MAC地址的转换

- MAC地址用于链路层转发

- MAC地址与网卡绑定

- FF-FF-FF-FF-FF-FF为广播MAC地址



**以太网 Ethernet**

- 主流LAN技术，98%市场占有率

- 廉价，常见带宽100MB 1G 10G

- 常用介质

  - 同轴电缆 -- 包含铜芯和外导体铜网，接入点刺破外导体，接入铜芯

  - 双绞线 -- 俗称网线

  - 光纤



**Ethernet帧格式**

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220701150301625.png" alt="image-20220701150301625" style="zoom: 80%;" />



**集线器 hub** -- *近似于用于公共接入的粗导线*

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220701151244117.png" alt="image-20220701151244117" style="zoom: 67%;" />

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220701152032489.png" alt="image-20220701152032489" style="zoom:50%;" />



**交换机 Switch** -- 多个端口间的瞬时切换开关

- 负责frame的存储转发

- 链路层设备



#### 6.6 数据中心网络

数据中心网络 -- 数十万台主机构成的局域网络

- 电子商务 -- Amazon Taobao

- 内容服务 -- YouTube Akamai Apple Tiktok

- 搜索引擎 -- Google Baidu Bing

关注高并发性能和负载均衡



### 第8章 网络安全

#### 8.1 网络安全定义

**Bob Alice Trudy模型**

- 网络安全经典抽象模型

- **Trudy坏事干尽**

  - 窃听

  - 插入

  - 伪装

  - 劫持 -- 建立通信后，接管会话，踢出其中一方



#### 8.2 加密原理

**对称加密**

对称密钥加密学 -- DES

对称密钥加密体系



**非对称加密**

RSA算法

![image-20220629003845452](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220629003845452.png)

<img src="https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220629004956615.png" alt="image-20220629004956615" style="zoom: 80%;" />



#### 8.3 认证

**认证** -- Bob要认证Alice的身份

- 通过签名实现

- **签名指用私钥加密，等价于打上自身标志**



#### 8.4 报文完整性

- 可验证

- 不可伪造

- 不可抵赖



**实现方法** -- 报文后追加**数字签名部分**

报文摘要算法 -- MD5 SHA-1

![image-20220629012322851](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220629012322851.png)

#### 8.5 密钥分发和证书

**通信双方安全共享对称密钥**

通过双方共同信赖的KDC中介实现



**安全获取公共密钥**

通过认证中心CA实现 -- certification authority

**证书** -- **由CA机构签名过的实体与实体公钥的捆绑关系**

![image-20220717172055494](https://figure-bed-zwd.oss-cn-hangzhou.aliyuncs.com/img_for_markdown/image-20220717172055494.png)





#### 8.6 各个层次的安全性

应用层安全性 -- 安全电子邮件

传输层安全性 -- SSL 安全套接字层

网络层安全性 -- IPsec

链路层安全性 -- IEEE 802.11



#### 8.7 防火墙

**防火墙** -- 一种**IP层网络安全设备**，位于内网和公网接口处，起隔离作用

- 基于IP报文头部信息进行block

- **block规则**由网络管理员配置



**DOS攻击**

Denial Of Service 拒绝服务攻击

- 攻击方发送大量连接请求，耗尽服务器资源

- 正常用户被拒绝服务

- 可用防火墙禁止行为异常的访问方



应用程序网关可以起防火墙作用





